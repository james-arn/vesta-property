# Google Analytics (GA4) Tracking Setup for Vesta Property Inspector

This document outlines the Google Analytics 4 (GA4) event tracking implementation for the Vesta Property Inspector Chrome Extension and associated services. The primary goal is to track the user journey from acquisition to premium feature usage and subscription.

## 1. Overview & Funnel

The desired user funnel and key tracked interactions are:

1.  **Ad Clicks / Campaign Source** (Tracked via UTM parameters on links to CWS).
2.  **Chrome Web Store (CWS) Listing Page Views** (Tracked by CWS built-in GA integration).
3.  **Extension Installation** (`extension_install` event).
4.  **Extension Usage (Free Tier)**:
    - Viewing property details (`property_analysed` event).
5.  **Upgrade Intention**:
    - Clicking an upgrade button (`upgrade_button_clicked` event).
6.  **Subscription Purchase** (`purchase` event, sent server-side via Stripe webhook & Lambda).
7.  **Premium Feature Usage / Token Consumption** (`token_used` event).

All events sent from the Chrome Extension include a `data_source: 'chrome_extension'` parameter. The `purchase` event sent from the Lambda includes `data_source: 'stripe_webhook'`. These require `data_source` to be registered as a custom dimension in the GA4 property.

## 2. Key GA4 Events Implemented

### From Chrome Extension:

- **`extension_install`**:
  - Triggered once when the extension is first installed.
  - Sent from `background.ts` on `chrome.runtime.onInstalled` (`details.reason === 'install'`).
- **`property_analysed`**:
  - Triggered when a user views the analysed data for a property.
  - Includes `property_id`.
  - Logic in `googleAnalyticsHelpers.ts` (`isNewPropertyAnalysisThisSession`) ensures this event is sent only once per unique property ID per browser session to avoid inflated counts for repeat views of the same property within a short timeframe.
- **`upgrade_button_clicked`**:
  - Triggered when a user clicks any "Upgrade" or "Go Premium" type button within the extension UI (e.g., in `UpsellModal.tsx`, `SettingsControls.tsx`).
  - Includes `button_location` (e.g., `upsell_modal_upgrade_now`, `settings_menu_upgrade`) and optionally `property_id` if the click is associated with a specific property.
- **`token_used`**:
  - Triggered after a user successfully uses a premium feature that consumes a token (e.g., after a successful `premiumDataQuery`).
  - Includes `property_id` and `tokens_spent` (currently always 1).

### From AWS Lambda (Server-Side):

- **`purchase`**:
  - Triggered when a Stripe `checkout.session.completed` webhook is successfully processed by the AWS Lambda function.
  - This is the primary event for tracking subscription conversions.
  - Crucially, this event uses the `client_id` (referred to as `extension_client_id`) passed from the Chrome Extension via the static site and Stripe Payment Link to correctly attribute the purchase to the original user session.
  - Parameters should include `transaction_id`, `value`, `currency`, `items` (subscription plan details), and the all-important `client_id`.

## 3. Passing `extension_client_id` for Purchase Attribution

To link a `purchase` event (server-side) back to the user's session in the Chrome Extension (client-side), the `client_id` generated by the extension (`getOrCreateClientId`) must be passed through the purchase flow.

**Flow:**

1.  **Extension**: When a user clicks an "Upgrade" button:

    - The `navigateToPricingPageWithGaParams` function in `googleAnalyticsHelpers.ts` is called.
    - This function retrieves the `extension_client_id`.
    - It constructs the URL to the static site's pricing page, appending the `extension_client_id` as a query parameter:
      `https://yourdomain.com/#pricing?extension_client_id=GENERATED_CLIENT_ID`
      (Uses `QUERY_PARAM_KEYS.EXTENSION_CLIENT_ID` for the parameter name).
    - The function correctly handles existing fragments (`#pricing`) and other potential query parameters in the base URL stored in `ENV_CONFIG.AUTH_PRICING_URL`.

2.  **Static Site (e.g., `vestapropertychecker.com`)**:

    - The JavaScript on the pricing page must read the `extension_client_id` from the URL query parameters.
    - This `extension_client_id` is then appended as the `client_reference_id` to the Stripe Payment Link URL.
      - Example: `https://buy.stripe.com/your_payment_link_id?client_reference_id=GENERATED_CLIENT_ID`

3.  **Stripe**:

    - When the user completes a purchase through this modified Stripe Payment Link, Stripe automatically includes the `client_reference_id` in the `checkout.session.completed` event payload.

4.  **AWS Lambda**:
    - The Lambda function listening to the `checkout.session.completed` webhook will find the `extension_client_id` in `session.client_reference_id`.
    - This ID is then used as the `client_id` when sending the `purchase` event to GA4 via the Measurement Protocol.

## 6. Development vs. Production GA Properties

The extension's `ENV_CONFIG` (derived from `.env.development` / `.env.production`) should point to the appropriate GA4 `MEASUREMENT_ID` and `API_SECRET` for each environment. The Lambda function should also use environment-specific GA4 credentials.
